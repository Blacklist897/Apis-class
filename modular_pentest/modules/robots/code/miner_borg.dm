/*
		MINER MODULES
*/

/obj/item/robot_module/miner
	name = "Miner"
	basic_modules = list(
		/obj/item/assembly/flash/cyborg,
		/obj/item/borg/sight/meson,
		/obj/item/storage/bag/ore/cyborg,
		/obj/item/pickaxe/drill/cyborg,
		/obj/item/shovel,
		/obj/item/crowbar/cyborg,
		/obj/item/weldingtool/mini,
		/obj/item/extinguisher/mini,
		/obj/item/storage/bag/sheetsnatcher/borg,
		/obj/item/gun/energy/kinetic_accelerator/cyborg,
		/obj/item/gps/cyborg,
		/obj/item/stack/marker_beacon)
	emag_modules = list(/obj/item/borg/stun)
	cyborg_base_icon = "miner"
	moduleselect_icon = "miner"
	hat_offset = 0
	var/obj/item/t_scanner/adv_mining_scanner/cyborg/mining_scanner

/obj/item/robot_module/miner/be_transformed_to(obj/item/robot_module/old_module)
	var/mob/living/silicon/robot/R = loc
	var/static/list/mining_icons
	if(!mining_icons)
		mining_icons = list(
		"Antique" = image(icon = 'icons/mob/robots.dmi', icon_state = "minerbot"),
		"Default" = image(icon = 'icons/mob/robots.dmi', icon_state = "miner"),
		"Droid" = image(icon = 'icons/mob/robots.dmi', icon_state = "droid-miner"),
		"Marina" = image(icon = 'icons/mob/robots.dmi', icon_state = "marinaMN"),
		"Sleek" = image(icon = 'icons/mob/robots.dmi', icon_state = "sleekminer"),
		"Kodiak" = image(icon = 'icons/mob/robots.dmi', icon_state = "kodiak-miner"),
		"Noble" = image(icon = 'icons/mob/robots.dmi', icon_state = "Noble-SUP"),
		"R34 - MIN2a 'Ishimura'" = image(icon = 'icons/mob/robots.dmi', icon_state = "ishimura"),
		"Meka Miner - F" = image(icon = 'modular_pentest/modules/robots/icons/mob/numekasf.dmi', icon_state = "fmekamine"),
		"Meka Miner - M" = image(icon = 'modular_pentest/modules/robots/icons/mob/numekasm.dmi', icon_state = "mmekamine"),
		)
		mining_icons = sortList(mining_icons)
	var/mining_borg_icon = show_radial_menu(R, R , mining_icons, custom_check = CALLBACK(src, PROC_REF(check_menu), R), radius = 42, require_near = TRUE)
	switch(mining_borg_icon)
		if("Antique")
			cyborg_base_icon = "minerbot"
			cyborg_icon_override = 'icons/mob/robots.dmi'
			special_light_key = "minerbot"
		if("Default")
			cyborg_base_icon = "miner"
		if("Droid")
			cyborg_base_icon = "droid-miner"
			cyborg_icon_override = 'icons/mob/robots.dmi'
			special_light_key = "droid-miner"
		if("Marina")
			cyborg_base_icon = "marinaMN"
			cyborg_icon_override = 'icons/mob/robots.dmi'
			special_light_key = "marinaMN"
		if("Sleek")
			cyborg_base_icon = "sleekminer"
			cyborg_icon_override = 'icons/mob/robots.dmi'
			special_light_key = "sleekminer"
		if("Kodiak")
			cyborg_base_icon = "kodiak-miner"
			cyborg_icon_override = 'icons/mob/robots.dmi'
			special_light_key = "kodiak-miner"
		if("Noble")
			cyborg_base_icon = "Noble-SUP"
			cyborg_icon_override = 'icons/mob/robots.dmi'
			special_light_key = "Noble-SUP"
		if("R34 - MIN2a 'Ishimura'")
			cyborg_base_icon = "ishimura"
			cyborg_icon_override = 'icons/mob/robots.dmi'
			special_light_key = "ishimura"
		if("Meka Miner - F")
			cyborg_base_icon = "fmekamine"
			cyborg_icon_override = 'modular_pentest/modules/robots/icons/mob/numekasf.dmi'
			special_light_key = "fmekamine"
		if("Meka Miner - M")
			cyborg_base_icon = "mmekamine"
			cyborg_icon_override = 'modular_pentest/modules/robots/icons/mob/numekasm.dmi'
			special_light_key = "mmekamine"
		else
			return FALSE
	return ..()

/obj/item/robot_module/miner/rebuild_modules()
	. = ..()
	if(!mining_scanner)
		mining_scanner = new(src)

/obj/item/robot_module/miner/Destroy()
	QDEL_NULL(mining_scanner)
	return ..()

//
// DRILL UPGRADE - BOARD AND UPGRADE CODE
//

/obj/item/borg/upgrade/ddrill
	name = "mining cyborg diamond drill"
	desc = "A diamond drill replacement for the mining module's standard drill."
	icon_state = "module_miner"
	require_module = 1
	model_type = list(/obj/item/robot_module/miner)

/obj/item/borg/upgrade/ddrill/action(mob/living/silicon/robot/R, user = usr)
	. = ..()
	if(.)
		for(var/obj/item/pickaxe/drill/cyborg/D in R.module)
			R.module.remove_module(D, TRUE)
		for(var/obj/item/shovel/S in R.module)
			R.module.remove_module(S, TRUE)

		var/obj/item/pickaxe/drill/cyborg/diamond/DD = new /obj/item/pickaxe/drill/cyborg/diamond(R.module)
		R.module.basic_modules += DD
		R.module.add_module(DD, FALSE, TRUE)

/obj/item/borg/upgrade/ddrill/deactivate(mob/living/silicon/robot/R, user = usr)
	. = ..()
	if (.)
		for(var/obj/item/pickaxe/drill/cyborg/diamond/DD in R.module)
			R.module.remove_module(DD, TRUE)

		var/obj/item/pickaxe/drill/cyborg/D = new (R.module)
		R.module.basic_modules += D
		R.module.add_module(D, FALSE, TRUE)
		var/obj/item/shovel/S = new (R.module)
		R.module.basic_modules += S
		R.module.add_module(S, FALSE, TRUE)

//
// SATCHEL OF HOLDING - BOARD AND UPGRADE CODE
//

/obj/item/borg/upgrade/soh
	name = "mining cyborg satchel of holding"
	desc = "A satchel of holding replacement for mining cyborg's ore satchel module."
	icon_state = "module_miner"
	require_module = 1
	model_type = list(/obj/item/robot_module/miner)

/obj/item/borg/upgrade/soh/action(mob/living/silicon/robot/R)
	. = ..()
	if(.)
		for(var/obj/item/storage/bag/ore/cyborg/S in R.module)
			R.module.remove_module(S, TRUE)

		var/obj/item/storage/bag/ore/holding/H = new /obj/item/storage/bag/ore/holding(R.module)
		R.module.basic_modules += H
		R.module.add_module(H, FALSE, TRUE)

/obj/item/borg/upgrade/soh/deactivate(mob/living/silicon/robot/R, user = usr)
	. = ..()
	if (.)
		for(var/obj/item/storage/bag/ore/holding/H in R.module)
			R.module.remove_module(H, TRUE)

		var/obj/item/storage/bag/ore/cyborg/S = new (R.module)
		R.module.basic_modules += S
		R.module.add_module(S, FALSE, TRUE)

//
// LAVAPROOF CHASSIS - BOARD AND UPGRADE CODE
//

/obj/item/borg/upgrade/lavaproof
	name = "mining cyborg lavaproof chassis"
	desc = "An upgrade kit to apply specialized coolant systems and insulation layers to a mining cyborg's chassis, enabling them to withstand exposure to molten rock."
	icon_state = "ash_plating"
	resistance_flags = LAVA_PROOF | FIRE_PROOF
	require_module = 1
	model_type = list(/obj/item/robot_module/miner)

/obj/item/borg/upgrade/lavaproof/action(mob/living/silicon/robot/R, user = usr)
	. = ..()
	if(.)
		R.weather_immunities += "lava"

/obj/item/borg/upgrade/lavaproof/deactivate(mob/living/silicon/robot/R, user = usr)
	. = ..()
	if (.)
		R.weather_immunities -= "lava"
